---
title: "Stills Annotations - Data summaries and exploration"
author: "Franziska Althaus"
date: "01/11/2019"
output: 
  html_document:
      toc: TRUE
      toc_float: TRUE
      code_folding: hide
      theme: "journal"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(cowplot)
library(knitr)
```

# Background

A survey of the seamounts south of Tasmania on board of the Australian Marine National Facility Vessel Investigator imagery of the seafloor was collected on transects using a towed camera system.
The imagery consist of Video and stereo still images. The data is structured into seamounts (Map Locations), transects (operations) and images that are geolocated in space. A selection of the stereo stills are processed to generate a quadrat of measured size overlaid on the image. The area within quadrats is annotated for (1) percent cover of substrate types with the matrix-forming coral (esp. _Solenosmilia variabilis_) being of particular interest, and for (2) counts of individuals of indicator taxa for 'VME' (Vulnerable Marine Ecosystems).

![**Plate 1** Example images of the habitats](figures/FIG2_ImagePlate.png){width=15cm}

# Image annotations

## 1. Percent cover annotations

Percent cover of substrate types is annotated using a point count approach in TransectMeasure software from [SEAGIS](https://www.seagis.com.au/). Random points at a density of 5 points.m^-2^) were thrown into the measured quadrat and annotated for 16 categories, including 3 matrix-forming coral species distinguished into live vs. dead, 4 other biogenic substrates, 5 non-biogenic substrate types and a not-scorable' category where no category could be assigned due to image limitation or obstruction by mobile fauna. The CATAMI classification ([Althaus et al. 2015](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0141039)) was used to define the substrate categories. Descriptive codes were used for each category for ease of data manipulation.In addition to the annotations of the random points an overall classification of the whole quadrat was applied to capture the overall impression, especially with regard to potential past fishing impact.

Codes and descriptions of the point categories used: 

* SC-ENLP: Cnidaria - Stony corals - Enalopsammia (live)
* SC-SOL: Cnidaria - Stony corals - Solenosmilia (live)
* SC-MAD: Cnidaria - Stony corals - Madrepora (live)
* SU-ENLP: Cnidaria - Stony corals - Enalopsammia (dead)
* SU-SOL: Cnidaria - Stony corals - Solenosmilia (dead)
* SU-MAD: Cnidaria - Stony corals - Madrepora (dead)
* SU-BCOR: Unconsolidate - Biogenic - Coral Rubble 
* SU-BBAR: Unconsolidate - Biogenic - Barnacle plates
* SU-BOTH: Unconsolidate - Biogenic - other
* SU-CONBIO: Consolidate - Biogenic - other (note this substrate types was not consistentlly recorded combine with xxx)
* SU-ROK: Consolidate - Rock
* SU-BOL: Consolidate - Boulder
* SU-COB: Consolidate - Cobbles
* SU-PEBGRAV: Unconsolidate - Pebble - gravel
* SU-SAMU: Unconsolidate - Sand/mud
* NS: Unscorable

## 2. VME taxa counts

Counts of indicator taxa for vulnerable marine ecosystems (VME) are made within each quadrat, allowing for calculating standardised densities per square metre. In addition, by-eye estimated of the percent cover of coral matrix (dead & alive combined) are recorded for the three types of matrix forming coral distinguished for percent cover annotations, in order to compare percent cover from point counts and estimates. Annotations are made in the CSIRO insidence of the MBARI developed Video Annotation and Registration System ([VARS](http://vars.it.csiro.au/)). The VME taxa targetted are listed below. Again, the CATAMI classification ([Althaus et al. 2015](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0141039)) was used to classify the taxa. The comments field in VARS is used to record counts and to record additional modifyiers such as colour of distinctive taxa within some of the VME taxon groups (e.g. yellow and brown stalked crinoids were distinguished). An additional category of 'No-VMEfauna' was added to indicate that an image was annotated but none of the taxa of interest were observed. 

VME taxa targetted:

* Sponges
* Stony corals: Branching: _S.variabilis_
* Stony corals: Branching: _Enalopsammia_
* Stony corals: Branching: _Madrepora_
* stony corals (other)
* Black & Octocorals
* Stalked crinoids
* Unstalked crinoid
* Brisingid
* True Anemones: Fourlobed
* Hydrocorals: Branching
* Hydrocorals (presence only recorded)

Additional taxa of interest:

* Regular urchins
* _Dermechinus horridus_ (a regular urchin)
* Irregular urchins

Percent cover of matrix forming coral (dead & alive), by-eye estimate:

* PC_Sub_CoralReef:  Coral reef species undetermined
* PC_Cub_EnallopMatrix: _Enallopsammia_ matrix
* PC_Sub_SolMatrix: _Solenosmilia_ matrix


# Data preparation and cleaning

## 1. Percent cover data

The TM raw output data set is a concatenation of all TM project outputs. Each of the output files consist of the point annotations within images and the 'user defined' point annotation for the entire image. The raw data extract is tidied up using the separate R script **Tidy_TM_Concat_data.R**. This separates the raw data into overview annotations and point annotations and transformed into percent cover by substrate category for each image. Then the latter are linked to image geolocation information and written out to .cvs as column-format data (PCcover.csv) and as matrix format (PCcoverbyImage.csv), for use in further analyses and for mapping in QGIS.

Note, at this stage the overview annotations were separated out from percent cover data but are not furher cleand or considered.

## 2. VME taxa counts

The VME taxon counts are extracted from the VARS Oracle data base using the script **VARS_2018-StillsAnnoExtracts.sql**. The raw data extract is tidied up using the separate R script **VME_anno_tidy.R**. The non-numrical comments are separated from the counts and percent covers; these are currently not further used. The numeric data is split into percent cover data and the counts. The latter are linked to the quadrat sizes and converted to densities (ind.m^-2^). each of the tables is linked to image geolocation information and written out to .cvs as column-format data (VMEanno_PCcoral.csv and VMEanno_DensQ.csv) and combined as matrix format (VMEannoMatrix.csv), for use in further analyses and for mapping in QGIS.

Note, at this stage the modifyiers (colour, etc) are not incorporated into the output data.
    
# Data exploration

Inital data summaries and plots based on the by image operations details and the five .csv files written out by the data cleaning process. 

```{r data loading}
# read all stills data and make depth numeric

AllSTills <- read_csv("data/IN2018_V06_AllStills.csv") %>% 
  mutate(depth=as.numeric(Z)) %>% 
  select(-c(Z))

PCcoverbyImage <- read_csv("Results/PCcoverbyImage.csv")
PC_cover <- read_csv("Results/PCcover.csv")

VMEanno_DensQ <- read_csv("Results/VMEanno_DensQ.csv")
VMEanno_PCcoral <- read_csv("Results/VMEanno_PCcoral.csv")
VMEannoMatrix <- read_csv("Results/VMEannoMatrix.csv")

nTarget <- summarise(AllSTills, sum(`Target RANSMPL (1/10)`))
#tried to call this in text xxx with `r view(nTarget)` but doesn't work
```

In total xxx images were targeted for annotation, of these `r nrow(PCcoverbyImage)` have been annotated for percent cover of substrate types, `r nrow(VMEannoMatrix)` have been annotated for VME taxa and zzz were identified as unsuitable for annotation and could not be replaced. Summary of the number of images targeted for stills analyses and the number of images annotated for percent cover and for VME taxa. (NOTE need to exclude operations that were not targeted from this summary)

```{r Ops summaries}
PC_done <- PCcoverbyImage %>% 
  group_by(SVY_OPS) %>% 
  summarise(PCdone=n())

VME_done <- VMEannoMatrix %>% 
  group_by(SVY_OPS) %>% 
  summarise(VMEdone=n())

## NOTE will need to limit the data here to target ops only
Target <- AllSTills %>% 
  group_by(SVY_OPS, MapLoc, `Target RANSMPL (1/10)`) %>% 
  summarise(RandSelection=n()) %>% 
  left_join(PC_done, by=c("SVY_OPS"="SVY_OPS")) %>% 
  left_join(VME_done, by=c("SVY_OPS"="SVY_OPS"))

kable(Target[1:6], caption="**Table 1** By operation processing summary")

```

## 1. Percent cover

In total there are `r nrow(PCcoverbyImage)` randomly selected images have been annotated for percent cover to date. In total `r nrow(PC_done)` operations have been (at least partially) annotated.  

Below is a summary of the data distribution across the targeted substrate types

```{r PCcover sumaries }

# check out the substrate codes that were annotated

PCsum <- PC_cover %>% 
  group_by(L2_Code) %>% 
  summarise(meanPCcover= mean(PC_cover), PresNo_Images = n())

kable(PCsum [1:3], caption="**Table 2** Summary of the data distribution across the targeted substrate types")

```

The depth distribution of the live and dead coral matrix are of particular interest in looking at the depth distribution of the substrate types. 

```{r by depth distribution, fig.cap="**Figure 1** depth distribution of substrate types"}
#distribution of the substrate types
# create a vector with the sequence of the substrate types for ordering them in a meaningful way
SubstSeq <- c('SC-ENLP',
              'SU-ENLP',
              'SC-SOL',
              'SU-SOL',
              'SC-MAD',
              'SU-MAD',
              'SU-BCOR',
              'SU-BBAR',
              'SU-BOTH',
              'SU-ROK',
              'SU-BOL',
              'SU-COB',
              'SU-CONBIO',
              'SU-PEBGRAV',
              'SU-SAMU',
              'NS')
ggplot(PC_cover,
       mapping= aes(x=factor(L2_Code, level =SubstSeq),              #call the pre existing vector
                    y=depth,
                    size=PC_cover)
  )+
  geom_point(alpha=0.2)+
  scale_y_reverse() +                            # reverse y-axis because it represents ocean depth 
  theme(axis.text.x = element_text(angle = 90))+   # rotate the label on x-axis
  labs(x="substrate type", y="depth")

```

Distribution of the substrate types by selected locations  

```{r PC cover pies, fig.cap="**Figure 2** pie charts of substrate distribution at selected locations"}
Fang <- PC_cover %>% 
  filter(MapLoc=="Fang") %>% 
  ggplot(Fang,
       mapping= aes(x="", 
                    y=PC_cover,               
                    fill=factor(L2_Code, level =SubstSeq)
       ))+
    geom_bar(stat="identity", width=1)+
    ggtitle("Fang")+
    coord_polar("y", start=0)
Fang

MainMatt <- PC_cover %>% 
  filter(MapLoc=="Main Matt") %>% 
  ggplot(MainMatt,
       mapping= aes(x="", 
                    y=PC_cover,               
                    fill=factor(L2_Code, level =SubstSeq)
       ))+
    geom_bar(stat="identity", width=1)+
      ggtitle("MainMatt")+
   coord_polar("y", start=0)
MainMatt

Pedra <- PC_cover %>% 
  filter(MapLoc=="Pedra") %>% 
  ggplot(Pedra,
       mapping= aes(x="", 
                    y=PC_cover,               
                    fill=factor(L2_Code, level =SubstSeq)
       ))+
    geom_bar(stat="identity", width=1)+
      ggtitle("Pedra")+
    coord_polar("y", start=0)
Pedra

Sisters <- PC_cover %>% 
  filter(MapLoc=="Sisters") %>% 
  ggplot(MainMatt,
       mapping= aes(x="", 
                    y=PC_cover,               
                    fill=factor(L2_Code, level =SubstSeq)
       ))+
    geom_bar(stat="identity", width=1)+
      ggtitle("Sisters")+
   coord_polar("y", start=0)
Sisters

z16 <- PC_cover %>% 
  filter(MapLoc=="z16") %>% 
  ggplot(z16,
       mapping= aes(x="", 
                    y=PC_cover,               
                    fill=factor(L2_Code, level =SubstSeq)
       ))+
   geom_bar(stat="identity", width=1)+
      ggtitle("z16")+
   coord_polar("y", start=0)
z16

Hill_U <- PC_cover %>% 
  filter(MapLoc=="Hill U") %>% 
  ggplot(Hill_U,
       mapping= aes(x="", 
                    y=PC_cover,               
                    fill=factor(L2_Code, level =SubstSeq)
       ))+
   geom_bar(stat="identity", width=1)+
      ggtitle("Hill_U")+
   coord_polar("y", start=0)
Hill_U

Hill_K1 <- PC_cover %>% 
  filter(MapLoc=="Hill K1") %>% 
  ggplot(Hill_U,
       mapping= aes(x="", 
                    y=PC_cover,               
                    fill=factor(L2_Code, level =SubstSeq)
       ))+
   geom_bar(stat="identity", width=1)+
      ggtitle("Hill_K1")+
   coord_polar("y", start=0)
Hill_K1

```

Looking at the distribution of coral matrix formed by _Solenosmilia_ (SC_SOL and SU_SOL) and coral rubble (SU_BCOR) in more detail, particularly by depth and location. 

```{r SV data}
CoralPC <- PC_cover %>% 
  filter(L2_Code == "SC-SOL" |
         L2_Code == "SU-SOL" |
         L2_Code == "SU-BCOR")
CoralPC

CoralPC %>% 
  ggplot(aes(x = PC_cover)) +
  facet_wrap(~ L2_Code) +
  geom_histogram()

```



